services:
  postgres:
    image: postgres
    container_name: ember-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DATABASE}
      POSTGRES_USER: ${POSTGRES_USERNAME}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - ember-postgres:/var/lib/postgresql/data
    networks:
      - ember-network

  mongo:
    image: mongo
    container_name: ember-mongo
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    ports:
      - "${MONGO_PORT}:27017"
    volumes:
      - ember-mongo:/data/db
    networks:
      - ember-network

  redis:
    image: redis/redis-stack:latest
    container_name: ember-redis
    command:
      - redis-server
      - --requirepass
      - ${REDIS_PASSWORD}
      - --maxmemory
      - 256mb
      - --maxmemory-policy
      - allkeys-lru
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - ember-redis:/data
    networks:
      - ember-network

  loki:
    image: grafana/loki:latest
    container_name: ember-loki
    command:
      - -config.file=/etc/loki/local-config.yaml
    ports:
      - "3100:3100"
    volumes:
      - ember-loki:/loki
    networks:
      - ember-network

  promtail:
    image: grafana/promtail:latest
    container_name: ember-promtail
    command:
      - -config.file=/etc/promtail/config.yaml
    ports: []
    volumes:
      - /var/log:/var/log
      - ./telemetry/promtail-config.yaml:/etc/promtail/config.yaml
    networks:
      - ember-network
    depends_on:
      - loki

  mimir:
    image: grafana/mimir:latest
    container_name: ember-mimir
    command:
      - -config.file=/etc/mimir.yaml
    ports:
      - "9009:9009"
    volumes:
      - ember-mimir:/data
      - ./telemetry/mimir.yaml:/etc/mimir.yaml
    networks:
      - ember-network

  tempo:
    image: grafana/tempo:latest
    container_name: ember-tempo
    command:
      - -config.file=/etc/tempo.yaml
    ports:
      - "3200:3200" # HTTP API
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
    volumes:
      - ember-tempo:/var/tempo
      - ./telemetry/tempo.yaml:/etc/tempo.yaml
    networks:
      - ember-network

  grafana:
    image: grafana/grafana:latest
    container_name: ember-grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
    ports:
      - "3000:3000"
    volumes:
      - ember-grafana:/var/lib/grafana
      - ./telemetry/provisioning:/etc/grafana/provisioning
    networks:
      - ember-network
    depends_on:
      - loki
      - mimir
      - tempo

  node-exporter:
    image: prom/node-exporter:latest
    container_name: ember-node-exporter
    ports:
      - "9100:9100"
    volumes: []
    networks:
      - ember-network

networks:
  ember-network:
    driver: bridge

volumes:
  ember-postgres:
  ember-mongo:
  ember-redis:
  ember-loki:
  ember-mimir:
  ember-tempo:
  ember-grafana:
